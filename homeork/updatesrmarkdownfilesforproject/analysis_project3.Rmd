---
date: "`r Sys.Date()`"
author: "Akua Kyeraa Sam"
title: "Modelling Consumer Cloud Services Choices Using the Multinomial Logit Model"
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.cap = TRUE, message = FALSE, 
                      
                      warning = FALSE)

## Install and load package manager
## NB: This section requires an internet connection

if(!require(pacman)){
        
        install.packages("pacman")
        
}

## Load required packages, installing them if not available
pacman::p_load(tidyverse, ggthemes, GGally, janitor, skimr, kableExtra, 
               
               huxtable, flextable, knitr, rmarkdown, officedown, 
               
               officer, corrplot, dendextend, flexclust, NbClust,
               
               here, questionr, ggmosaic, OddsPlotty, tidymodels,
               
               lift, data.table,  dfidx, bbplot, mlogit, lmtest)

## Set theme for plots
theme_set(bbplot::bbc_style())

## Set number of significant digits
options(digits = 2)


fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', bold = TRUE)
```

# Project 3: Cloud Computing

## Background

For this project I run a Choice-Based Conjoint study in the Cloud Services Platform market (e.g. Amazon Web Services, Google Cloud, Microsoft Azure). The client wants to make some product design decisions such as core feature-sets, pricing, and tiers of service to optimise revenue or new sign-ups.

I work with the cloud.csv file. The file contains data on choices made by 200
respondents. Each respondent evaluated 15 choice sets. Thus, the file contains data on 200 × 15 = 3000 choice sets. Each choice set had three alternatives. A respondent’s task was to choose one alternative from a choice set. The following table describes the variables in the dataset ^[This section is from the question paper]:

```{r}
tribble(~ Variable, ~ Description,
        
        "respondent_id", "Identifier for each respondent (1 to 200)",
        
        "choiseset_id", "Identifier for each choice set for each respondent (1 to 15)",
        
        "alternative_id", "Identifier for each alternative in a choice set (1 to 3)",
        
        "choice_id", "Identifier for each choice set in the entire study (1 to 3000)",
        
        "cloud_storage", "Attribute cloud storage with three levels: 30GB / 2000GB /
5000GB",

"customer_support", "Attribute customer support with two levels: Yes / No",

"cloud_services", "Attribute cloud services with three levels: Email / Email + Video /
Email + Video + Productivity",

"price", "Attribute price with three levels: £6 per month / £12 per month /
£18 per month", 

"choice", "Shows which alternative was chosen in each choice set (Dummy
coded: 1 if alternative was chosen; 0 otherwise)") %>% 
        
        flextable() %>% 
        
        theme_vanilla() %>% 
        
        set_caption(caption = "Variables Description")
```

## QUESTION 1: The Data

I start by reading and exploring the data. 

```{r}
cloud_data <- read.csv("cloud (2).csv", stringsAsFactors = TRUE)

glimpse(cloud_data) 
```

Note that the R version I am using does not automatically convert strings or character variables to factors. 

The `respondent_id` variable is a `double` that can take on decimals. The variable has `r length(unique(cloud_data$respondent_id))` unique ids. 

The `choiseset_id` variable is also a double with `r length(unique(cloud_data$choiseset_id))` unique observations. 

The `alternative_id` variable is also a double with `r length(unique(cloud_data$alternative_id))` unique observations. 

The `choice_id` variable is also a double with `r length(unique(cloud_data$choice_id))` unique observations. 

The `cloud_storage` variable is also a character variable with `r length(unique(cloud_data$cloud_storage))` unique observations. 

The `customer_support` variable is also a character variable with `r length(unique(cloud_data$customer_support))` unique observations. 

The `cloud_services` variable is also a character variable with `r length(unique(cloud_data$cloud_services))` unique observations. 

The `price` variable is also a character variable with `r length(unique(cloud_data$price))` unique observations. 

The `choice` variable is also a double with `r length(unique(cloud_data$choice))` unique observations. 

## QUESTION 2: Convert Strings to Factors
I convert all the strings to factors. By default, R chooses factor levels in alphabetical order of the data. For instance, for the variable cloud_storage, R will choose levels in the following order; 2000gb, 30gb, 5000gb. Likewise, for price, R will choose factor levels as p12, p18, and p6. Hence, we have to re-level these factors to the desired order. 

For all the other variables, the default choice of levels is sensible while others are numeric. 

```{r}
cloud_data <- cloud_data %>% 
        
        mutate(cloud_storage = factor(cloud_storage, 
                                      
                                      levels = c("30gb", "2000gb", "5000gb")),
               
               price = factor(price, levels = c("p6", "p12", "p18")),
               
               choice_id = factor(choice_id))

glimpse(cloud_data) 
```


## QUESTION 3: Average Prices

For the price variable, there are three categories; p6, p12, and p18 which capture different price levels, \$6, \$12, and \$18 respectively. I extract the prices from the variable and compute the mean price. The mean price is \$12. 

```{r}
cloud_data <- cloud_data %>% 
        
        mutate(price_n = as.character(price) %>% 
                       
                       parse_number())
        
cloud_data %>% summarise(mean_price = mean(price_n))
```


## QUESTION 4: Choice of 30GB Cloud Storage and Email Only Cloud Service

There are 830 people who choose 30gb cloud storage. 

```{r}
xtabs(choice ~ cloud_storage, data = cloud_data)

cloud_data %>% 
        
        filter(choice == 1, cloud_storage == "30gb") %>% 
        
        nrow()
```

Approximately 28% of the customers choose the email only service. 

```{r}
cloud_data %>% 
        
        filter(choice == 1, cloud_storage == "30gb") %>% 
        
        summarise(prop = n()/ nrow(cloud_data) * 100 * 3)
```

## QUESTION 5: Data for the Multinonial Logit Model
In this section, I create a specially formatted data object to use for running the multinomial logit model. 

```{r}
m_data <- dfidx::dfidx(cloud_data, idx = list(c("choice_id", 
                                                
                                                "respondent_id")),
                       
                       choice = "choice", 
                       
                       levels = unique(cloud_data$alternative_id))
```

## QUESTION 6: Model 1

Next, I run a multinomial logit model without an intercept. 

```{r}
set.seed(123)

model1 <- mlogit(choice ~ 0 + cloud_storage + customer_support + cloud_services + price, data = m_data)

summary(model1)
```

The coefficients for `cloud_storage5000gb` is positive while that of `pricep12` is negative. Both coefficients are significant at 1% significance level. Compared to the `cloud_storage30gb`, consumers are more likely to purchase the 5000gb option. Likewise compared to the package `p6`, consumers are less likely to purchase the bundle `p12` and `p18`. Taking the exponentials of the coefficients indicates the likelihood (odds) of consumers purchasing one bundle over the other. 

```{r}
model1 %>% coef() %>% exp()
```

## QUESTION 7: Model 2
In this section, I use the actual price of the choice alternatives in place of the price bands. The actual price is in the variable `price_n`. 

```{r}
set.seed(123)

model2 <- mlogit(choice ~ 0 + cloud_storage + customer_support + cloud_services + price_n, data = m_data)

summary(model2)
```

The coefficient for `price_n` is negative and significant at 1% significance level. The coefficient means that a rise in price corresponds to an decrease in the probability of purchase. In terms of odds, a unit rise in price increases the likelihood of a purchase by a factor of `r exp(model2$coefficients[6])`. 

## QUESTION 8: Likelihood Ratio Test for the Two Models
 In comparing `model1` and `model2`, I run a likelihood ratio test. The null hypothesis is that model1 fits the model best. The alternative is that model2 fits the model better than model 1. 
 
```{r}
lrtest(model1, model2)
```

The output shows an insignificant chi-square. The two models are significantly different. Hence, I pick model1 over model2. 


## QUESTION 9: Predicted probability of choosing 3rd alternative in first choice set
I make predictions using model m2 and extract the third alternative in the first choice set. 

```{r}
my_predictions <- model2 %>% 
        
        predict(newdata = m_data) %>% 
        
        data.frame() %>% 
        
        mutate(identifier = paste0("Y", 1:nrow(.))) %>% 
        
        pivot_longer(-identifier, 
                     
                     names_to = "choice_m", 
                     
                     values_to = "values") %>% 

        bind_cols(cloud_data) %>% 
        
        group_by(choiseset_id) %>%

        mutate(choice_pred = case_when(
                
                values == max(values) ~ 1,
                
                TRUE ~ 0
                
        )) %>% 
        
        ungroup()
```


```{r}
my_predictions %>% 
        
        filter(choiseset_id == 1, alternative_id == 3) %>% 
        
        filter(values == max(values)) %>% 
        
        pull(values)
```


## QUESTION 10: Predicted Alternative in 3rd Choice Set

The predicted alternative in the third choice set is 5000gb with customer support for email, video and productivity at a price of 6. 


```{r}
my_predictions %>% 
        
        filter(choiseset_id == 3) %>% 
        
        filter(values == max(values)) %>% 
        
        select(cloud_storage, customer_support, cloud_services, price)
```

## QUESTION 11: Selected alternative in the fifteenth choice set?

The selected alternatives in the 15th choice set are in the table below. For brevity, I show the first ten choices.

```{r}
my_predictions %>% 
        
        filter(choiseset_id == 15, choice == 1) %>% 
        
        select(choice, alternative_id, cloud_storage, customer_support,
               
               cloud_services, price) %>% 
        
        head(10) %>% 
        
        flextable() %>% 
        
        theme_vanilla() %>% 
        
        set_caption(caption = "Predicted Alternatives for the 15th Choice Set")
```


## QUESTION 12: Confusion Matrix and Hit Rate

The Table below shows the confusion matrix. The hit rate or accuracy of the model is 
`r (5998 + 13)/nrow(cloud_data)`.

```{r}
my_predictions %>% 
        
select(choice_pred, choice) %>% 
        
        table()


null_predictions <- tibble(choice = m_data$choice, choice_pred = rep(0, nrow(m_data)))
        
table(null_predictions$choice, null_predictions$choice_pred)   
```

For a null model that predicts that every person will not select any option, the accuracy is 66.7%. Our model does slightly better than the null model. However, the model does better in determining which customers will not purchase (specificity) than the null model. We can then use the model to target consumers that are likely to buy. 

### QUESTION 13: Function to Predict Market Shares
The function below allows us to compute market shares for a hypothetical market. 

```{r}

predict.share <- function(new_data, model){
        
        
        data.model <- model.matrix(update(model$formula, 0 ~ .),
                                   
                                   data = new_data)[,-1]
        
        utility <- data.model %*% model$coef
        
        share <- exp(utility) / sum(exp(utility))
        
        cbind(share, new_data)
}

```

## QUESTION 14: Data Object to Compute Market Shares

In this section, I compute hypothetical market shares with the data below.  

```{r}
d_base <- tribble(~ cloud_storage, ~ customer_support, ~ cloud_services, ~ price_n,
                  
                  "30gb", "no", "email", 6,
                  
                  "30gb", "no", "email, video", 12,
                  
                  "30gb", "yes", "email", 12,
                  
                  "5000gb", "yes", "email", 18, 
                  
                  "5000gb", "no", "email, video, productivity", 18
                  ) %>% 
        
        mutate(cloud_storage = factor(cloud_storage, 
                                      
                levels = levels(cloud_data$cloud_storage)),
               
               customer_support = factor(customer_support,
                                         
              levels = levels(cloud_data$customer_support)),
              
              
              cloud_services = factor(cloud_services,
                                         
              levels = levels(cloud_data$cloud_services))
              
              
                                         )

d_base %>% 
        
        flextable() %>% 
        
        theme_vanilla() %>% 
        
        set_caption(caption = "Data Set 1 for Prediction")

```


## QUESTION 15: Predicting Market Shares

The market shares for this hypothetical model is show below.

```{r}
predict.share(d_base, model = model2) %>% 
        
        tibble() %>% 
        
        flextable() %>% 
        
        theme_vanilla() %>% 
        
        set_caption(caption = "Predicted Market Shares 1")
```

Alternative 4 has a market share of 14.5%. 

## QUESTION 16: Changing a Variable
I change the fifth alternative in this scenario to "email, video". The market share for alternative 4 changes from 14.5% to 19%. 

```{r}
d_base2 <- tribble(~ cloud_storage, ~ customer_support, ~ cloud_services, ~ price_n,
                  
                  "30gb", "no", "email", 6,
                  
                  "30gb", "no", "email, video", 12,
                  
                  "30gb", "yes", "email", 12,
                  
                  "5000gb", "yes", "email", 18, 
                  
                  "5000gb", "no", "email, video", 18) %>% 
        
        mutate(cloud_storage = factor(cloud_storage, 
                                      
                levels = levels(cloud_data$cloud_storage)),
               
               customer_support = factor(customer_support,
                                         
              levels = levels(cloud_data$customer_support)),
              
              
              cloud_services = factor(cloud_services,
                                         
              levels = levels(cloud_data$cloud_services))
              
              
                                         )

d_base2 %>% 
        
        flextable() %>% 
        
        theme_vanilla() %>% 
        
        set_caption(caption = "Data Set 2 for Prediction")


```


```{r}
predict.share(d_base2, model = model2) %>% 
        
        flextable() %>% 
        
        theme_vanilla() %>% 
        
        set_caption(caption = "Predicted Market Shares 2")
```

## QUESTION 17: Alternative Affected the Most by the Change Above (Q16)

Alternative 5 has been affected the most by this change. However, the change is positive with an increase of 17.7%. 

```{r}
bind_cols(predict.share(d_base, model = model2) %>% tibble() %>% select(share),
predict.share(d_base2, model = model2) %>% 
        
        tibble() %>% 
        
        select(share)) %>% 
        
        mutate(diff = share...1 - share...2) %>% 
        
        flextable() %>% 
        
        theme_vanilla() %>% 
        
        set_caption(caption = "Changes in Market Shares")
```


## QUESTION 18: How much (in £ per month) for customer support.

In this section, I compute how much customers are willing to pay for customer support. In this case, I divide the coefficient for `customer_supportyes` with the negative value of the price coefficient. The output that customers are on average willing to pay £ `r coef(model2)[3] / - coef(model2)[6]` per month for customer support. 

```{r}
coef(model2)[3] / - coef(model2)[6]
```

## QUESTION 19: Upgrade from 30GB to 2000GB

Similar to question 18, a customer is willing to pay £ `r coef(model2)[1] / - coef(model2)[6]`

```{r}
coef(model2)[1] / - coef(model2)[6]
```


## QUESTION 20: Upgrade from 2000GB to 5000GB

The consumer is willing to pay £ `r coef(model2)[2] / - coef(model2)[6] - coef(model2)[1] / - coef(model2)[6]` to upgrade from 2000gb to 5000gb cloud storage

```{r}
coef(model2)[2] / - coef(model2)[6] - coef(model2)[1] / - coef(model2)[6]
```

